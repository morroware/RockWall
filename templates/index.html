<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>RockWall Timer Control</title>
  <style>
    :root {
      /* Dark theme matching Pygame display */
      --bg-primary: #0c0f18;
      --bg-secondary: #101520;
      --bg-card: #1c2230;
      --bg-card-hover: #242a3a;
      --bg-elevated: #283040;

      /* Accent colors */
      --accent: #64b4ff;
      --accent-bright: #82c8ff;
      --accent-glow: rgba(100, 180, 255, 0.3);

      /* State colors */
      --state-ready: #fafcff;
      --state-running: #ff5a5a;
      --state-paused: #ffc107;
      --state-finished: #00f082;

      /* Text colors */
      --text-primary: #fafcff;
      --text-secondary: #c8d2e1;
      --text-muted: #8c9baf;

      /* Borders and shadows */
      --border-subtle: rgba(255, 255, 255, 0.08);
      --border-accent: rgba(100, 180, 255, 0.3);
      --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.3);
      --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.4);
      --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.5);
      --shadow-glow: 0 0 20px var(--accent-glow);

      /* Spacing and sizing */
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 24px;

      /* Transitions */
      --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
      --transition-normal: 250ms cubic-bezier(0.4, 0, 0.2, 1);
      --transition-slow: 400ms cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html {
      font-size: 16px;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', 'Roboto', sans-serif;
      background: linear-gradient(180deg, var(--bg-primary) 0%, #040608 100%);
      color: var(--text-primary);
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      min-height: 100vh;
    }

    /* Container */
    .container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 32px;
    }

    /* Header */
    .header {
      text-align: center;
      margin-bottom: 48px;
      position: relative;
    }

    .header-title {
      font-size: 3rem;
      font-weight: 800;
      letter-spacing: -0.02em;
      background: linear-gradient(135deg, var(--text-primary) 0%, var(--accent-bright) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 8px;
    }

    .header-subtitle {
      font-size: 1rem;
      color: var(--text-muted);
      font-weight: 400;
    }

    .header-line {
      width: 120px;
      height: 3px;
      background: linear-gradient(90deg, transparent, var(--accent), transparent);
      margin: 24px auto 0;
      border-radius: 2px;
    }

    /* Status Bar */
    .status-bar {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 32px;
      margin-top: 32px;
      padding: 20px 32px;
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-subtle);
    }

    .status-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }

    .status-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-muted);
      font-weight: 500;
    }

    .status-value {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .status-value.connected {
      color: var(--state-finished);
    }

    .status-value.error {
      color: var(--state-running);
    }

    /* Lane Cards Grid */
    .lanes-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(420px, 1fr));
      gap: 24px;
      margin-bottom: 48px;
    }

    /* Lane Card */
    .lane-card {
      background: var(--bg-card);
      border-radius: var(--radius-xl);
      border: 1px solid var(--border-subtle);
      padding: 32px;
      position: relative;
      overflow: hidden;
      transition: transform var(--transition-normal), box-shadow var(--transition-normal), border-color var(--transition-normal);
    }

    .lane-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--state-ready);
      opacity: 0.3;
      transition: opacity var(--transition-normal), background var(--transition-normal);
    }

    .lane-card.running::before {
      background: var(--state-running);
      opacity: 1;
      animation: pulse-glow 1.5s ease-in-out infinite;
    }

    .lane-card.paused::before {
      background: var(--state-paused);
      opacity: 1;
    }

    .lane-card.finished::before {
      background: var(--state-finished);
      opacity: 1;
    }

    .lane-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
      border-color: var(--border-accent);
    }

    .lane-card.running {
      border-color: rgba(255, 90, 90, 0.3);
    }

    .lane-card.paused {
      border-color: rgba(255, 193, 7, 0.3);
    }

    .lane-card.finished {
      border-color: rgba(0, 240, 130, 0.3);
    }

    @keyframes pulse-glow {
      0%, 100% { opacity: 0.6; }
      50% { opacity: 1; }
    }

    /* Lane Header */
    .lane-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .lane-number {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .lane-number::before {
      content: '';
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--text-muted);
      transition: background var(--transition-normal), box-shadow var(--transition-normal);
    }

    .lane-card.running .lane-number::before {
      background: var(--state-running);
      box-shadow: 0 0 12px var(--state-running);
    }

    .lane-card.paused .lane-number::before {
      background: var(--state-paused);
      box-shadow: 0 0 12px var(--state-paused);
    }

    .lane-card.finished .lane-number::before {
      background: var(--state-finished);
      box-shadow: 0 0 12px var(--state-finished);
    }

    /* Status Chip */
    .status-chip {
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      transition: all var(--transition-normal);
    }

    .status-chip.ready {
      background: rgba(250, 252, 255, 0.1);
      color: var(--state-ready);
      border: 1px solid rgba(250, 252, 255, 0.2);
    }

    .status-chip.running {
      background: rgba(255, 90, 90, 0.15);
      color: var(--state-running);
      border: 1px solid rgba(255, 90, 90, 0.3);
      animation: chip-pulse 1.5s ease-in-out infinite;
    }

    .status-chip.paused {
      background: rgba(255, 193, 7, 0.15);
      color: var(--state-paused);
      border: 1px solid rgba(255, 193, 7, 0.3);
    }

    .status-chip.finished {
      background: rgba(0, 240, 130, 0.15);
      color: var(--state-finished);
      border: 1px solid rgba(0, 240, 130, 0.3);
    }

    @keyframes chip-pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.03); }
    }

    /* Timer Display */
    .timer-display {
      font-family: 'SF Mono', 'Monaco', 'Consolas', 'Courier New', monospace;
      font-size: 4rem;
      font-weight: 700;
      text-align: center;
      padding: 40px 24px;
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      margin-bottom: 28px;
      color: var(--text-muted);
      letter-spacing: 0.02em;
      border: 2px solid var(--border-subtle);
      position: relative;
      overflow: hidden;
      transition: all var(--transition-normal);
    }

    .timer-display::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(180deg, rgba(255,255,255,0.02) 0%, transparent 50%);
      pointer-events: none;
    }

    .timer-display.running {
      color: var(--state-running);
      border-color: rgba(255, 90, 90, 0.4);
      background: linear-gradient(180deg, rgba(255, 90, 90, 0.08) 0%, var(--bg-secondary) 100%);
      text-shadow: 0 0 30px rgba(255, 90, 90, 0.4);
    }

    .timer-display.paused {
      color: var(--state-paused);
      border-color: rgba(255, 193, 7, 0.4);
      background: linear-gradient(180deg, rgba(255, 193, 7, 0.08) 0%, var(--bg-secondary) 100%);
      text-shadow: 0 0 30px rgba(255, 193, 7, 0.3);
    }

    .timer-display.finished {
      color: var(--state-finished);
      border-color: rgba(0, 240, 130, 0.4);
      background: linear-gradient(180deg, rgba(0, 240, 130, 0.08) 0%, var(--bg-secondary) 100%);
      text-shadow: 0 0 30px rgba(0, 240, 130, 0.3);
    }

    /* Controls */
    .controls {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
    }

    .btn {
      padding: 14px 20px;
      border: none;
      border-radius: var(--radius-md);
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-fast);
      text-transform: uppercase;
      letter-spacing: 0.03em;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      position: relative;
      overflow: hidden;
      min-height: 52px;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 50%;
      background: linear-gradient(180deg, rgba(255,255,255,0.1) 0%, transparent 100%);
      pointer-events: none;
    }

    .btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .btn:active:not(:disabled) {
      transform: translateY(0);
    }

    .btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      transform: none;
    }

    .btn-start {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
    }

    .btn-start:hover:not(:disabled) {
      background: linear-gradient(135deg, #34d399 0%, #10b981 100%);
    }

    .btn-stop {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
    }

    .btn-stop:hover:not(:disabled) {
      background: linear-gradient(135deg, #f87171 0%, #ef4444 100%);
    }

    .btn-reset {
      background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
      color: white;
    }

    .btn-reset:hover:not(:disabled) {
      background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%);
    }

    .btn-sound {
      background: linear-gradient(135deg, var(--accent) 0%, #2563eb 100%);
      color: white;
    }

    .btn-sound:hover:not(:disabled) {
      background: linear-gradient(135deg, var(--accent-bright) 0%, var(--accent) 100%);
    }

    .btn.loading {
      pointer-events: none;
    }

    .btn.loading::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      animation: shimmer 1s infinite;
    }

    @keyframes shimmer {
      100% { left: 100%; }
    }

    /* Section Cards */
    .section-card {
      background: var(--bg-card);
      border-radius: var(--radius-xl);
      padding: 32px;
      margin-bottom: 32px;
      border: 1px solid var(--border-subtle);
    }

    .section-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .section-title::before {
      content: '';
      width: 4px;
      height: 24px;
      background: var(--accent);
      border-radius: 2px;
    }

    /* High Scores */
    .scores-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
    }

    .score-column {
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      padding: 24px;
      border: 1px solid var(--border-subtle);
      transition: border-color var(--transition-normal);
    }

    .score-column:hover {
      border-color: var(--border-accent);
    }

    .score-column h3 {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border-subtle);
    }

    .score-list {
      list-style: none;
    }

    .score-list li {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 0;
      font-family: 'SF Mono', monospace;
      font-size: 0.9rem;
      color: var(--text-muted);
      border-bottom: 1px solid var(--border-subtle);
    }

    .score-list li:last-child {
      border-bottom: none;
    }

    .score-rank {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 700;
      background: var(--bg-elevated);
      color: var(--text-muted);
    }

    .score-list li:first-child .score-rank {
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      color: #1f2937;
    }

    .score-list li:nth-child(2) .score-rank {
      background: linear-gradient(135deg, #d1d5db 0%, #9ca3af 100%);
      color: #1f2937;
    }

    .score-list li:nth-child(3) .score-rank {
      background: linear-gradient(135deg, #cd7f32 0%, #a0522d 100%);
      color: white;
    }

    .score-time {
      font-weight: 600;
      color: var(--text-primary);
    }

    .score-list li:first-child .score-time {
      color: #fbbf24;
    }

    /* Configuration */
    .config-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 24px;
      margin-bottom: 28px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .form-group label {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text-secondary);
    }

    .form-group input,
    .form-group select {
      padding: 12px 16px;
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      font-size: 0.9rem;
      background: var(--bg-secondary);
      color: var(--text-primary);
      transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }

    .form-group select option {
      background: var(--bg-card);
      color: var(--text-primary);
    }

    .config-buttons {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .config-buttons .btn {
      flex: 1;
      min-width: 160px;
    }

    /* Notifications */
    .notification {
      position: fixed;
      top: 32px;
      right: 32px;
      padding: 16px 24px;
      border-radius: var(--radius-md);
      color: white;
      font-weight: 600;
      font-size: 0.9rem;
      z-index: 1000;
      transform: translateX(calc(100% + 40px));
      transition: transform var(--transition-normal);
      box-shadow: var(--shadow-lg);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .notification.show {
      transform: translateX(0);
    }

    .notification.success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }

    .notification.error {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }

    /* Connection Status */
    .connection-status {
      position: fixed;
      bottom: 32px;
      right: 32px;
      padding: 10px 20px;
      border-radius: 24px;
      font-size: 0.8rem;
      font-weight: 600;
      z-index: 999;
      background: var(--bg-card);
      box-shadow: var(--shadow-md);
      transition: all var(--transition-normal);
      display: flex;
      align-items: center;
      gap: 8px;
      border: 1px solid var(--border-subtle);
    }

    .connection-status .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      transition: background var(--transition-normal), box-shadow var(--transition-normal);
    }

    .connection-status.connected .dot {
      background: var(--state-finished);
      box-shadow: 0 0 8px var(--state-finished);
    }

    .connection-status.disconnected .dot {
      background: var(--state-running);
      box-shadow: 0 0 8px var(--state-running);
    }

    .connection-status.connected {
      color: var(--state-finished);
    }

    .connection-status.disconnected {
      color: var(--state-running);
    }

    /* Best Time Display */
    .best-time {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-top: 16px;
      padding: 12px 16px;
      background: var(--bg-elevated);
      border-radius: var(--radius-md);
      border: 1px solid var(--border-subtle);
    }

    .best-time-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-muted);
      font-weight: 500;
    }

    .best-time-value {
      font-family: 'SF Mono', monospace;
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--accent);
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .lanes-grid {
        grid-template-columns: repeat(auto-fit, minmax(360px, 1fr));
      }

      .controls {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 768px) {
      .container {
        padding: 20px;
      }

      .header-title {
        font-size: 2rem;
      }

      .lanes-grid {
        grid-template-columns: 1fr;
      }

      .timer-display {
        font-size: 2.5rem;
        padding: 28px 16px;
      }

      .controls {
        grid-template-columns: repeat(2, 1fr);
      }

      .connection-status {
        bottom: 16px;
        right: 16px;
        padding: 8px 16px;
        font-size: 0.75rem;
      }

      .notification {
        top: 16px;
        right: 16px;
        left: 16px;
        transform: translateY(-150%);
      }

      .notification.show {
        transform: translateY(0);
      }

      .status-bar {
        gap: 16px;
        padding: 16px;
      }

      .status-item {
        min-width: 80px;
      }
    }

    @media (max-width: 480px) {
      .timer-display {
        font-size: 2rem;
      }

      .lane-number {
        font-size: 1.25rem;
      }

      .btn {
        padding: 12px 16px;
        font-size: 0.8rem;
        min-height: 48px;
      }
    }
  </style>
</head>
<body>
  <div class="connection-status connected" id="connectionStatus">
    <span class="dot"></span>
    <span>Connected</span>
  </div>

  <div class="container">
    <header class="header">
      <h1 class="header-title">RockWall Timer</h1>
      <p class="header-subtitle">Professional Climbing Wall Timer System</p>
      <div class="header-line"></div>

      <div class="status-bar">
        <div class="status-item">
          <span class="status-label">System</span>
          <span class="status-value connected" id="systemStatus">Online</span>
        </div>
        <div class="status-item">
          <span class="status-label">Last Update</span>
          <span class="status-value" id="lastUpdate">--:--:--</span>
        </div>
        <div class="status-item">
          <span class="status-label">Active</span>
          <span class="status-value" id="activeTimers">0</span>
        </div>
        <div class="status-item">
          <span class="status-label">Refresh</span>
          <span class="status-value" id="updateRate">1.0s</span>
        </div>
      </div>
    </header>

    <div class="lanes-grid" id="lanesContainer"></div>

    <section class="section-card">
      <h2 class="section-title">High Scores</h2>
      <div class="scores-grid" id="highScores"></div>
    </section>

    <section class="section-card">
      <h2 class="section-title">Configuration</h2>
      <div class="config-grid">
        <div class="form-group">
          <label for="updateInterval">Web Update Interval (seconds)</label>
          <input type="number" id="updateInterval" min="0.5" max="5" step="0.5" value="1">
        </div>
        <div class="form-group">
          <label for="soundEnabled">Sound Effects</label>
          <select id="soundEnabled">
            <option value="true">Enabled</option>
            <option value="false">Disabled</option>
          </select>
        </div>
        <div class="form-group">
          <label for="scrollSpeed">Display Scroll Speed (1-10)</label>
          <input type="number" id="scrollSpeed" min="1" max="10" value="3">
        </div>
      </div>
      <div class="config-buttons">
        <button class="btn btn-start" onclick="saveConfig()">Save Configuration</button>
        <button class="btn btn-sound" onclick="exportData()">Export Data</button>
        <button class="btn btn-reset" onclick="resetAllLanes()">Reset All Lanes</button>
      </div>
    </section>
  </div>

  <div class="notification" id="notification"></div>

  <script>
    // Application state
    let currentState = null;
    let updateInterval = null;
    let isConnected = true;
    let webUpdateRate = 1000;

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadInitialConfig();
      startUpdating();
      updateState();
      setupEventListeners();
    });

    function setupEventListeners() {
      document.getElementById('updateInterval').addEventListener('change', (e) => {
        webUpdateRate = parseFloat(e.target.value) * 1000;
        startUpdating();
        document.getElementById('updateRate').textContent = `${e.target.value}s`;
      });

      document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
          clearInterval(updateInterval);
        } else {
          startUpdating();
          updateState();
        }
      });

      window.addEventListener('online', () => {
        isConnected = true;
        updateConnectionStatus(true);
        startUpdating();
      });

      window.addEventListener('offline', () => {
        isConnected = false;
        updateConnectionStatus(false);
      });
    }

    function showNotification(message, type = 'success', duration = 2500) {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.className = `notification ${type} show`;
      setTimeout(() => {
        notification.classList.remove('show');
      }, duration);
    }

    function updateConnectionStatus(connected) {
      const element = document.getElementById('connectionStatus');
      element.innerHTML = `<span class="dot"></span><span>${connected ? 'Connected' : 'Disconnected'}</span>`;
      element.className = `connection-status ${connected ? 'connected' : 'disconnected'}`;
    }

    async function updateState() {
      if (!isConnected) return;

      try {
        const response = await fetch('/api/state', {
          signal: AbortSignal.timeout(5000)
        });

        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const data = await response.json();
        if (data.error) throw new Error(data.error);

        currentState = data;
        updateDisplay();

        document.getElementById('systemStatus').textContent = 'Online';
        document.getElementById('systemStatus').className = 'status-value connected';
        document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();

        const activeCount = data.lanes.filter(l => l.running).length;
        const pausedCount = data.lanes.filter(l => l.paused).length;
        document.getElementById('activeTimers').textContent =
          activeCount + (pausedCount > 0 ? ` (${pausedCount} paused)` : '');

        if (!isConnected) {
          isConnected = true;
          updateConnectionStatus(true);
        }

      } catch (error) {
        console.error('Update error:', error);
        document.getElementById('systemStatus').textContent = 'Error';
        document.getElementById('systemStatus').className = 'status-value error';

        if (error.name === 'AbortError' || error.name === 'TypeError') {
          isConnected = false;
          updateConnectionStatus(false);
        }
      }
    }

    function updateDisplay() {
      if (!currentState || !currentState.lanes) return;
      updateLanes();
      updateHighScores();
    }

    function updateLanes() {
      const container = document.getElementById('lanesContainer');

      if (container.children.length === 0) {
        container.innerHTML = '';
        currentState.lanes.forEach(lane => {
          container.appendChild(createLaneCard(lane));
        });
      } else {
        currentState.lanes.forEach((lane, index) => {
          updateLaneCard(container.children[index], lane);
        });
      }
    }

    function getLaneStatus(lane) {
      if (lane.running) {
        return { text: 'Running', class: 'running', chipClass: 'running' };
      } else if (lane.paused) {
        return { text: 'Paused', class: 'paused', chipClass: 'paused' };
      } else if (lane.has_been_stopped) {
        return { text: 'Finished', class: 'finished', chipClass: 'finished' };
      }
      return { text: 'Ready', class: 'ready', chipClass: 'ready' };
    }

    function createLaneCard(lane) {
      const div = document.createElement('div');
      div.dataset.laneId = lane.id;

      const status = getLaneStatus(lane);
      div.className = `lane-card ${status.class}`;

      const bestScore = currentState.high_scores && currentState.high_scores[lane.id]
        ? currentState.high_scores[lane.id][0]
        : null;

      div.innerHTML = `
        <div class="lane-header">
          <div class="lane-number">Lane ${lane.id + 1}</div>
          <div class="status-chip ${status.chipClass}">${status.text}</div>
        </div>
        <div class="timer-display ${status.class}">${lane.formatted_time}</div>
        ${bestScore ? `
          <div class="best-time">
            <span class="best-time-label">Best</span>
            <span class="best-time-value">${bestScore.toFixed(3)}s</span>
          </div>
        ` : ''}
        <div style="margin-top: 20px;">
          <div class="controls">
            <button class="btn btn-start" onclick="controlLane(${lane.id}, 'start')">${lane.running ? 'Pause' : lane.paused ? 'Reset' : 'Start'}</button>
            <button class="btn btn-stop" onclick="controlLane(${lane.id}, 'stop')" ${!lane.running && !lane.paused ? 'disabled' : ''}>Stop</button>
            <button class="btn btn-reset" onclick="controlLane(${lane.id}, 'reset')">Reset</button>
            <button class="btn btn-sound" onclick="playSound(${lane.id})">Sound</button>
          </div>
        </div>
      `;

      return div;
    }

    function updateLaneCard(card, lane) {
      const status = getLaneStatus(lane);
      card.className = `lane-card ${status.class}`;

      const chipEl = card.querySelector('.status-chip');
      chipEl.className = `status-chip ${status.chipClass}`;
      chipEl.textContent = status.text;

      const timerEl = card.querySelector('.timer-display');
      timerEl.className = `timer-display ${status.class}`;
      timerEl.textContent = lane.formatted_time;

      const startBtn = card.querySelector('.btn-start');
      startBtn.textContent = lane.running ? 'Pause' : lane.paused ? 'Reset' : 'Start';

      const stopBtn = card.querySelector('.btn-stop');
      stopBtn.disabled = !lane.running && !lane.paused;

      // Update best time
      const bestScore = currentState.high_scores && currentState.high_scores[lane.id]
        ? currentState.high_scores[lane.id][0]
        : null;

      let bestTimeEl = card.querySelector('.best-time');
      if (bestScore) {
        if (!bestTimeEl) {
          bestTimeEl = document.createElement('div');
          bestTimeEl.className = 'best-time';
          const controlsWrapper = card.querySelector('.controls').parentElement;
          controlsWrapper.parentElement.insertBefore(bestTimeEl, controlsWrapper);
        }
        bestTimeEl.innerHTML = `
          <span class="best-time-label">Best</span>
          <span class="best-time-value">${bestScore.toFixed(3)}s</span>
        `;
      } else if (bestTimeEl) {
        bestTimeEl.remove();
      }
    }

    function updateHighScores() {
      const container = document.getElementById('highScores');
      container.innerHTML = '';

      if (!currentState.high_scores) {
        container.innerHTML = '<p style="color: var(--text-muted);">No high scores yet</p>';
        return;
      }

      Object.entries(currentState.high_scores).forEach(([id, scores]) => {
        const column = document.createElement('div');
        column.className = 'score-column';

        let scoresHtml = '';
        if (scores.length > 0) {
          scoresHtml = scores.slice(0, 5).map((score, index) => `
            <li>
              <span class="score-rank">${index + 1}</span>
              <span class="score-time">${score.toFixed(3)}s</span>
            </li>
          `).join('');
        } else {
          scoresHtml = '<li style="color: var(--text-muted); justify-content: center;">No scores yet</li>';
        }

        column.innerHTML = `
          <h3>Lane ${parseInt(id) + 1}</h3>
          <ul class="score-list">${scoresHtml}</ul>
        `;

        container.appendChild(column);
      });
    }

    async function controlLane(laneId, action) {
      const button = event.target;
      button.classList.add('loading');
      const originalText = button.textContent;

      try {
        const response = await fetch(`/api/control/${laneId}/${action}`, {
          method: 'POST',
          signal: AbortSignal.timeout(3000)
        });

        const result = await response.json();
        if (result.error) throw new Error(result.error);

        showNotification(`Lane ${laneId + 1}: ${action} successful`);
        setTimeout(updateState, 50);

      } catch (error) {
        showNotification(`Failed: ${error.message}`, 'error');
      } finally {
        setTimeout(() => {
          button.classList.remove('loading');
          updateState();
        }, 200);
      }
    }

    async function playSound(laneId) {
      const button = event.target;
      button.disabled = true;

      try {
        const response = await fetch(`/api/sound/${laneId}`, {
          method: 'POST',
          signal: AbortSignal.timeout(3000)
        });

        const result = await response.json();
        if (result.error) throw new Error(result.error);

        if (result.success) {
          showNotification(`Sound played for Lane ${laneId + 1}`);
        } else {
          showNotification('Sound disabled', 'error');
        }

      } catch (error) {
        showNotification(`Sound error: ${error.message}`, 'error');
      } finally {
        setTimeout(() => {
          button.disabled = false;
        }, 500);
      }
    }

    async function loadInitialConfig() {
      try {
        const response = await fetch('/api/config');
        if (!response.ok) throw new Error('Failed to load config');

        const config = await response.json();

        document.getElementById('soundEnabled').value = config.sound_enabled ? 'true' : 'false';

        if (config.scroll_speed) {
          // Convert internal speed to UI value (internal is in px/s, UI is 1-10)
          const uiValue = Math.round(config.scroll_speed / 60);
          document.getElementById('scrollSpeed').value = Math.min(10, Math.max(1, uiValue));
        }

      } catch (error) {
        console.error('Config load error:', error);
      }
    }

    async function saveConfig() {
      const button = event.target;
      button.classList.add('loading');
      button.textContent = 'Saving...';

      try {
        const scrollValue = parseInt(document.getElementById('scrollSpeed').value);
        const config = {
          sound_enabled: document.getElementById('soundEnabled').value === 'true',
          scroll_speed: scrollValue * 60 // Convert UI value (1-10) to px/s
        };

        const response = await fetch('/api/config', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(config)
        });

        const result = await response.json();
        if (result.error) throw new Error(result.error);

        showNotification('Configuration saved successfully');

      } catch (error) {
        showNotification(`Save failed: ${error.message}`, 'error');
      } finally {
        setTimeout(() => {
          button.classList.remove('loading');
          button.textContent = 'Save Configuration';
        }, 300);
      }
    }

    async function resetAllLanes() {
      if (!confirm('Reset all lanes to 00:00.000?')) return;

      const button = event.target;
      button.classList.add('loading');
      button.textContent = 'Resetting...';

      try {
        const promises = currentState.lanes.map(lane =>
          fetch(`/api/control/${lane.id}/reset`, { method: 'POST' })
        );

        await Promise.all(promises);
        showNotification('All lanes reset successfully');
        setTimeout(updateState, 50);

      } catch (error) {
        showNotification('Reset failed', 'error');
      } finally {
        setTimeout(() => {
          button.classList.remove('loading');
          button.textContent = 'Reset All Lanes';
        }, 300);
      }
    }

    function exportData() {
      try {
        const data = {
          timestamp: new Date().toISOString(),
          lanes: currentState.lanes,
          high_scores: currentState.high_scores
        };

        const blob = new Blob([JSON.stringify(data, null, 2)], {
          type: 'application/json'
        });

        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `rockwall-export-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);

        showNotification('Data exported successfully');

      } catch (error) {
        showNotification('Export failed', 'error');
      }
    }

    function startUpdating() {
      if (updateInterval) {
        clearInterval(updateInterval);
      }
      updateInterval = setInterval(updateState, webUpdateRate);
    }
  </script>
</body>
</html>
